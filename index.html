<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Portal</title>
    <!-- ==================================================================== -->
    <!-- AD INTEGRATION SCRIPTS - Global/Preload Scripts (STAYS IN HEAD) -->
    <!-- ==================================================================== -->
    <!-- Google AdSense Account Verification Tag -->
    <meta name="google-adsense-account" content="ca-pub-4693135656555503">
    <!-- Adsterra Ad Script (main file) -->
    <script type='text/javascript' src='//pl28010937.effectivegatecpm.com/98/af/00/98af00b47d4c8002deb94f9193db79c7.js'></script>
    
    <!-- Adsterra Ad Script (Banner/Native Code) -->
    <script async="async" data-cfasync="false" src="//pl28010970.effectivegatecpm.com/6ef7d747884a1184f4736d7ecff2f631/invoke.js"></script>
    
    <!-- Adsterra Ad Script -->
    <script type='text/javascript' src='//pl28010977.effectivegatecpm.com/9a/2a/94/9a2a942d3b63dcb9ceca8278f350f2a2.js'></script>

    <!-- Ad Script (From provided URL) -->
    <script type='text/javascript' src='//www.effectivegatecpm.com/s5iuf1djt4?key=3b5a0211ee202edf9f14d809609ce43a'></script>
    <!-- ==================================================================== -->
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Three.js for 3D Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Custom styles for professional, light appearance and transitions */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F8F8; /* Light White Background */
            position: relative;
            z-index: 1;
        }
        .card {
            /* Light Glassmorphism Effect */
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(0, 0, 0, 0.1); /* Subtle Border */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); 
            position: relative;
            z-index: 10;
        }
        .input-style {
            background-color: #FFFFFF; /* White input background */
            color: #1F2937; /* Dark text */
            border-color: #4f46e5;
            transition: all 0.2s;
        }
        .input-style::placeholder {
            color: #6B7280; 
        }
        .input-style:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5); 
            border-color: #6366f1;
        }

        /* Base transition class for content sections */
        .transition-container {
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        
        /* Interactive Link Button Style - High Contrast Data Points */
        .link-button {
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, background-color 0.15s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.1); 
            cursor: pointer;
            background-color: #F3F4F6; /* Light Gray Background */
            border: 1px solid rgba(79, 70, 229, 0.1);
            color: #1F2937; /* Dark text */
        }
        .link-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15), 0 4px 6px rgba(0, 0, 0, 0.2);
            background-color: #E5E7EB;
        }
        .link-button:active {
            transform: translateY(1px) scale(0.98);
        }

        /* General Button Active State */
        button:active {
            transform: scale(0.98);
        }

        /* THREE.js Canvas Styling for Background */
        #threeCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0; 
            opacity: 0.8; /* Subtle visual background */
            pointer-events: none;
        }
        /* Custom Colors for Light Theme */
        .text-f-light { color: #1F2937; } /* Dark text */
        .text-f-secondary { color: #4F46E5; } /* Primary Indigo */
        .bg-f-dark { background-color: #FFFFFF; } /* White panel */
    </style>
</head>
<!-- UPDATED: Added flex-col to force vertical stacking of elements (ads and card) -->
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <!-- THREE.js Canvas Element -->
    <canvas id="threeCanvas"></canvas>

    <!-- TOP AD: Adsterra Ad Unit Container (Banner Placement) -->
    <div class="w-full max-w-5xl mb-4 p-2 text-center rounded-lg bg-gray-100 shadow-inner border border-gray-300">
        <div id="container-6ef7d747884a1184f4736d7ecff2f631"></div>
        <p class="text-xs text-gray-400 mt-1">Advertisement</p>
    </div>

    <div class="w-full max-w-5xl p-6 sm:p-10 rounded-xl card space-y-8">
        
        <!-- Header: Logo and Subtitle -->
        <header class="text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold flex items-center justify-center space-x-3 mb-2">
                <!-- Logo Image: Increased size from h-10/h-12 to h-12/h-16 -->
                <img src="https://www.iare.ac.in/sites/default/files/design_templates/IARE_Logo_A4_Color.png" alt="IARE Logo" class="h-12 sm:h-16 w-auto">
            </h1>
            <p class="text-center text-gray-600 mt-2">
                Securely retrieve student credentials and document links.
            </p>
        </header>

        <!-- Step 1: Initial Input and Action Section (Always visible) -->
        <div id="initialInputGroup" class="grid grid-cols-1 sm:grid-cols-7 gap-4">
            
            <!-- Roll Number Input (4/7 width on desktop) -->
            <input type="text" id="rollNumberInput" placeholder="Enter Roll Number"
                   class="col-span-full sm:col-span-4 p-3 border-2 border-indigo-500 rounded-lg focus:ring-indigo-300 text-lg font-mono uppercase tracking-wider input-style"
                   maxlength="10" />
            
            <!-- NEW Semester Select (2/7 width on desktop) -->
            <select id="semesterSelect" 
                    class="col-span-full sm:col-span-2 p-3 border-2 border-indigo-500 rounded-lg focus:ring-indigo-300 text-lg input-style">
                <option value="">-- Select Semester --</option>
                <option value="SEM1">SEM 1</option>
                <option value="SEM2">SEM 2</option>
                <option value="SEM3">SEM 3</option>
                <option value="SEM4">SEM 4</option>
                <option value="SEM5">SEM 5</option>
                <option value="SEM6">SEM 6</option>
                <option value="SEM7">SEM 7</option>
                <option value="SEM8">SEM 8</option>
            </select>

            <!-- Button (1/7 width on desktop) -->
            <button id="viewButton" onclick="fetchStudentProfile()"
                    class="col-span-full sm:col-span-1 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 ease-in-out shadow-lg shadow-indigo-500/50 transform hover:scale-[1.01] active:scale-95 flex items-center justify-center space-x-2">
                <i data-lucide="database" class="w-5 h-5"></i>
                <span id="buttonText">Fetch Profile</span>
            </button>
        </div>
        
        <!-- Status Message Box -->
        <div id="statusMessage" class="hidden p-3 rounded-lg text-center text-sm font-medium transition-all duration-300 text-f-light border border-indigo-500/50">
            <!-- Dynamic status messages will appear here -->
        </div>

        <!-- Backtracking Control Row (Visible when data is fetched) -->
        <div id="backtrackControl" class="pt-4 pb-2 hidden transition-container opacity-0 translate-y-4">
            <button onclick="resetToStep1()" 
                    class="text-sm text-indigo-600 hover:text-indigo-400 font-medium flex items-center space-x-1 p-2 rounded-lg transition duration-200 active:scale-95">
                <i data-lucide="arrow-left-circle" class="w-4 h-4"></i>
                <span>Change Profile/Semester</span>
            </button>
        </div>


        <!-- Display Area (Step 2 and 3) -->
        <!-- Added transition and initial hidden state classes -->
        <div id="dataContainer" class="hidden grid grid-cols-1 md:grid-cols-3 gap-8 pt-0 transition-container opacity-0 translate-y-4">

            <!-- Profile Photo Section (1/3 width on desktop) -->
            <div class="md:col-span-1 p-6 bg-f-dark rounded-xl border border-indigo-500/50 space-y-4 shadow-md">
                <h2 class="text-xl font-bold text-indigo-700 border-b border-indigo-500/50 pb-2 flex items-center space-x-2">
                    <i data-lucide="user-circle-2" class="w-6 h-6"></i>
                    <span>Access Key & Identity</span>
                </h2>
                <div class="flex justify-center">
                    <img id="profileImage" src="https://placehold.co/200x200/a3a3a3/ffffff?text=Enter+Roll+No" alt="Student Profile Photo"
                         class="w-48 h-48 object-cover rounded-full border-4 border-indigo-500 shadow-lg shadow-indigo-300 cursor-pointer transition duration-300 transform hover:scale-105 active:scale-95"
                         onclick="checkMissingFileStatus()">
                </div>
                <p id="imageStatus" class="text-center text-sm text-gray-500">
                    If photo fails to load, file integrity check failed.
                </p>
            </div>

            <!-- Workbook Control Panel / Lab Work Section (2/3 width on desktop) -->
            <div class="md:col-span-2 p-6 bg-f-dark rounded-xl border border-gray-300 space-y-4 shadow-md">
                
                <!-- NEW BLOCK: General Documents (SSC, etc.) -->
                <div id="generalDocsGroup" class="space-y-4">
                    <h2 class="text-xl font-bold text-f-light border-b border-gray-300 pb-2">
                        <i data-lucide="folder-open" class="w-6 h-6 inline-block mr-2 text-indigo-600"></i>
                        Core Document Index
                    </h2>
                    <p class="text-md text-gray-600 font-medium">
                        Retrieve general student certificates (opens in new data stream).
                    </p>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="viewGeneralDocument('SSC')"
                                class="bg-yellow-600 hover:bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md shadow-yellow-500/50 transform hover:scale-[1.02] active:scale-95 flex items-center space-x-2 text-sm">
                            <i data-lucide="certificate" class="w-4 h-4"></i>
                            <span>SSC Certificate</span>
                        </button>
                        <button onclick="viewGeneralDocument('INTER')"
                                class="bg-cyan-600 hover:bg-cyan-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md shadow-cyan-500/50 transform hover:scale-[1.02] active:scale-95 flex items-center space-x-2 text-sm">
                            <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                            <span>INTER Certificate</span>
                        </button>
                    </div>
                </div>
                
                <!-- Separator -->
                <hr class="my-4 border-gray-300" /> 

                <!-- Step 2: Course Code Input and Button -->
                <!-- Added transition and initial hidden state classes -->
                <div id="courseCodeInputGroup" class="space-y-4 hidden transition-container opacity-0 translate-y-4">
                    <h2 class="text-xl font-bold text-f-light border-b border-gray-300 pb-2">
                        <i data-lucide="book-open" class="w-6 h-6 inline-block mr-2 text-indigo-600"></i>
                        Execute Workbook Query
                    </h2 >
                    <p id="contextMessage" class="text-md text-gray-600 font-medium">
                        Enter the **Course Code** below to load lab documents for the selected semester.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-3 items-center">
                        
                        <!-- Course Code Input (2/3 width) -->
                        <input type="text" id="subjectCodeInput" placeholder="Enter Course Code"
                               class="w-full sm:w-2/3 p-3 border-2 border-green-500/50 rounded-lg focus:ring-green-400 text-lg font-mono uppercase tracking-wider input-style"
                               maxlength="10" />
                        <!-- Button to Fetch Workbooks (1/3 width) -->
                        <button id="fetchWorkbooksButton" onclick="fetchWorkbooks()"
                                class="w-full sm:w-1/3 bg-green-600 hover:bg-green-500 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 shadow-md shadow-green-500/50 transform hover:scale-[1.02] active:scale-95 flex items-center justify-center space-x-2">
                            <i data-lucide="file-check" class="w-5 h-5"></i>
                            <span>Fetch Workbooks</span>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Lab Work Display (Initially hidden) -->
                <!-- Added transition and initial hidden state classes -->
                <div id="labWorkSection" class="space-y-4 hidden transition-container opacity-0 translate-y-4">
                    <div class="flex justify-between items-center border-b border-gray-300 pb-2">
                        <h2 class="text-xl font-bold text-f-light" id="labWorkTitle">
                            <i data-lucide="book-open-text" class="w-6 h-6 inline-block mr-2 text-indigo-600"></i>
                            10 Weeks of Lab Work
                        </h2>
                        <button onclick="resetToStep2()" class="text-sm text-gray-600 hover:text-indigo-600 font-medium flex items-center space-x-1 transition duration-200 active:scale-95">
                            <i data-lucide="undo" class="w-4 h-4"></i>
                            <span>Change Query</span>
                        </button>
                    </div>
                    
                    <div id="labWorkList" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mt-4">
                        <!-- Dynamic lab work links will be inserted here -->
                    </div>
                    <p class="text-center text-xs text-gray-500 pt-2">
                        **Troubleshooting Tip:** Hover over a button to see the full S3 URL being used.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================================================================== -->
    <!-- DOWN ADS: Ad Units Moved to BODY for Proper Rendering -->
    <!-- ==================================================================== -->

    <!-- High Performance Ad 1 (key: 2ca3c18e46200bae5a4b71354503e56b) -->
    <div class="w-full max-w-5xl text-center mx-auto mt-4 mb-4">
        <script type="text/javascript">
            atOptions = {
                'key' : '2ca3c18e46200bae5a4b71354503e56b',
                'format' : 'iframe',
                'height' : 300,
                'width' : 160,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/2ca3c18e46200bae5a4b71354503e56b/invoke.js"></script>
        <p class="text-xs text-gray-400 mt-1">Advertisement 1</p>
    </div>

    <!-- High Performance Ad 2 (key: e02fdc0e6ee0c05d64741a5b337ebbe5) -->
    <div class="w-full max-w-5xl text-center mx-auto mt-4 mb-8">
        <script type="text/javascript">
            atOptions = {
                'key' : 'e02fdc0e6ee0c05d64741a5b337ebbe5',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/e02fdc0e6ee0c05d64741a5b337ebbe5/invoke.js"></script>
        <p class="text-xs text-gray-400 mt-1">Advertisement 2</p>
    </div>
    <!-- ==================================================================== -->


    <!-- Initialization of Lucide Icons -->
    <script>
        lucide.createIcons();

        // --- THREE.JS GLOBALS ---
        let scene, camera, renderer, particles;
        const canvas = document.getElementById('threeCanvas');
        let width = window.innerWidth;
        let height = window.innerHeight;

        /**
         * Initializes the Three.js scene, camera, and particle geometry.
         */
        function initThreeJS() {
            // 1. Scene setup
            scene = new THREE.Scene();
            
            // 2. Camera setup 
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.z = 20; // Pulled back for wider field of view

            // 3. Renderer setup
            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
            renderer.setSize(width, height);
            renderer.setClearColor(0x0d0e13, 0); 

            // 4. Particle Geometry (Data Network)
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const particleCount = 500;
            
            for (let i = 0; i < particleCount; i++) {
                // Random positions within a large cube area
                const x = (Math.random() - 0.5) * 200;
                const y = (Math.random() - 0.5) * 200;
                const z = (Math.random() - 0.5) * 200;
                vertices.push(x, y, z);
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            // Particle Material (Subtle Light Blue for White Background)
            const material = new THREE.PointsMaterial({
                color: 0xADD8E6, // Light Blue
                size: 0.3, 
                sizeAttenuation: true, // Particles closer look bigger
                transparent: true,
                opacity: 0.8
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // 5. Handle resizing
            window.addEventListener('resize', onWindowResize, false);
            
            // Start the animation loop
            animate();
        }

        /**
         * Handles window resizing.
         */
        function onWindowResize() {
            width = window.innerWidth;
            height = window.innerHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        /**
         * The main rendering loop for the animation.
         */
        function animate() {
            requestAnimationFrame(animate);

            // Rotate the entire particle field slowly, giving a sense of depth and movement
            if (particles) {
                particles.rotation.x += 0.0005;
                particles.rotation.y += 0.001;
            }

            renderer.render(scene, camera);
        }

        // --- CONFIGURATION ---
        const S3_BUCKET_BASE = 'https://iare-data.s3.ap-south-1.amazonaws.com/uploads/STUDENTS/';
        const PROFILE_FILE_EXT = 'jpg';
        const LAB_WORK_FILE_EXT = 'pdf';
        
        // Configuration for General Documents
        const DOCS_PATH = 'DOCS/'; 
        const DOC_FILE_EXT = 'jpg';
        // -----------------------

        const rollNumberInput = document.getElementById('rollNumberInput');
        const semesterSelect = document.getElementById('semesterSelect');
        const subjectCodeInput = document.getElementById('subjectCodeInput'); 
        
        const profileImage = document.getElementById('profileImage');
        const labWorkList = document.getElementById('labWorkList');
        const dataContainer = document.getElementById('dataContainer');
        const courseCodeInputGroup = document.getElementById('courseCodeInputGroup');
        const labWorkSection = document.getElementById('labWorkSection');
        const backtrackControl = document.getElementById('backtrackControl');
        
        const statusMessage = document.getElementById('statusMessage');
        const labWorkTitle = document.getElementById('labWorkTitle');
        const contextMessage = document.getElementById('contextMessage');
        const defaultProfilePlaceholder = 'https://placehold.co/200x200/a3a3a3/ffffff?text=No+Photo';
        
        let currentProfileUrl = ''; 
        let currentStudentData = {}; 

        // --- STATE MANAGEMENT FUNCTIONS ---

        function resetToStep1() {
            dataContainer.classList.add('opacity-0', 'translate-y-4');
            backtrackControl.classList.add('opacity-0', 'translate-y-4');

            setTimeout(() => {
                labWorkList.innerHTML = '';
                profileImage.src = defaultProfilePlaceholder;
                profileImage.classList.remove('border-red-500', 'border-dashed');
                currentProfileUrl = '';
                profileImage.onerror = handleImageError;

                dataContainer.classList.add('hidden');
                courseCodeInputGroup.classList.add('hidden');
                labWorkSection.classList.add('hidden');
                backtrackControl.classList.add('hidden');

                rollNumberInput.value = '';
                semesterSelect.value = '';
                subjectCodeInput.value = '';

                dataContainer.classList.remove('translate-y-4');
                backtrackControl.classList.remove('translate-y-4');
                
                showStatus('Please enter the Roll Number and select the Semester to begin.', 'info');
            }, 400); 
        }

        function showStep2() {
            courseCodeInputGroup.classList.remove('hidden');
            courseCodeInputGroup.classList.add('opacity-0', 'translate-y-4');
            labWorkSection.classList.add('hidden', 'opacity-0', 'translate-y-4');
            backtrackControl.classList.remove('hidden');

            setTimeout(() => {
                courseCodeInputGroup.classList.remove('opacity-0', 'translate-y-4');
                backtrackControl.classList.remove('opacity-0', 'translate-y-4');
            }, 10); 

            const { rollNumber, semesterCode } = currentStudentData;
            contextMessage.innerHTML = `Profile successfully fetched for <span class="font-semibold text-indigo-600">${rollNumber}</span> in <span class="font-semibold text-indigo-600">${semesterCode}</span>. Now, enter the Course Code below to load the lab documents.`;
            showStatus(`Profile connection established. Ready for Workbook Query.`, 'info');
        }

        function showStep3(subjectCode, semesterCode) {
            labWorkSection.classList.remove('hidden');
            labWorkSection.classList.add('opacity-0', 'translate-y-4');
            courseCodeInputGroup.classList.add('hidden', 'opacity-0', 'translate-y-4');
            backtrackControl.classList.remove('hidden');
            
            setTimeout(() => {
                labWorkSection.classList.remove('opacity-0', 'translate-y-4');
            }, 10); 

            showStatus(`Data stream complete. Now displaying lab links for ${subjectCode}.`, 'info');
        }

        function resetToStep2() {
            labWorkSection.classList.add('opacity-0', 'translate-y-4');
            
            setTimeout(() => {
                labWorkSection.classList.add('hidden');
                subjectCodeInput.value = "";
                showStep2();
            }, 400); 
        }

        // --- UTILITY FUNCTIONS ---
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            
            let colorClasses;
            if (type === 'error') {
                colorClasses = ['bg-red-200', 'text-red-800', 'border', 'border-red-500'];
            } else if (type === 'warning') {
                colorClasses = ['bg-orange-200', 'text-orange-800', 'border', 'border-orange-500'];
            } else {
                colorClasses = ['bg-indigo-100', 'text-indigo-800', 'border', 'border-indigo-500'];
            }
            
            // Note: Removed the dark background class removals since they are not used in the light theme status box.
            statusMessage.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-orange-200', 'text-orange-800', 'bg-indigo-100', 'text-indigo-800', 'border', 'border-red-500', 'border-indigo-500', 'border-orange-500');
            
            statusMessage.classList.add(...colorClasses);
            statusMessage.classList.remove('hidden');
        }

        function handleImageError() {
            profileImage.src = defaultProfilePlaceholder; 
            profileImage.classList.add('border-red-500', 'border-dashed'); 
            profileImage.classList.remove('border-indigo-500'); // Changed from border-cyan-400
            profileImage.onerror = null;
            showStatus('Profile image failed to load. Click the image to verify the URL in a new tab.', 'error');
        }

        function checkMissingFileStatus() {
            if (profileImage.classList.contains('border-red-500')) {
                 if (currentProfileUrl) {
                    window.open(currentProfileUrl, '_blank'); 
                    showStatus('Opening profile URL in a new tab to show the file status from S3. Check for "Key Does Not Exist".', 'info');
                 }
            } else {
                showStatus('Profile image loaded successfully, no issue detected.', 'info');
            }
        }
        
        function viewGeneralDocument(docType) {
            const { rollNumber } = currentStudentData;
            
            if (!rollNumber) {
                showStatus('Please fetch the student profile first.', 'error');
                return;
            }

            const fileName = `${rollNumber}_${docType.toUpperCase()}.${DOC_FILE_EXT}`;
            const docUrl = `${S3_BUCKET_BASE}${rollNumber}/${DOCS_PATH}${fileName}`;

            window.open(docUrl, '_blank');
            showStatus(`Opening ${docType} link for ${rollNumber}. Check the new tab.`, 'info');
        }
        
        // --- MAIN APPLICATION LOGIC ---

        function fetchStudentProfile() {
            const rollNumber = rollNumberInput.value.trim().toUpperCase();
            const semesterCode = semesterSelect.value;
            
            if (rollNumber.length === 0 || semesterCode === "") {
                showStatus('ERROR: Enter Roll Number AND select a Semester to fetch the profile.', 'error');
                dataContainer.classList.add('hidden');
                return;
            }

            dataContainer.classList.add('opacity-0');
            backtrackControl.classList.add('opacity-0');

            setTimeout(() => {
                labWorkList.innerHTML = '';
                profileImage.src = defaultProfilePlaceholder;
                profileImage.classList.remove('border-red-500', 'border-dashed');
                profileImage.classList.add('border-indigo-500'); // Reverted to primary color
                currentProfileUrl = '';
                profileImage.onerror = handleImageError;
                
                currentStudentData = { rollNumber, semesterCode };

                currentProfileUrl = `${S3_BUCKET_BASE}${rollNumber}/${rollNumber}.${PROFILE_FILE_EXT}`;
                profileImage.src = currentProfileUrl;
                
                dataContainer.classList.remove('hidden'); 
                
                setTimeout(() => {
                    dataContainer.classList.remove('opacity-0');
                    backtrackControl.classList.remove('opacity-0');
                }, 10);
                
                showStep2();
            }, 10);
        }

        function fetchWorkbooks() {
            const subjectCode = subjectCodeInput.value.trim().toUpperCase();
            const { rollNumber, semesterCode } = currentStudentData;

            if (subjectCode === "") {
                showStatus('ERROR: Please enter the Course Code before fetching workbooks.', 'error');
                return;
            }
            
            labWorkTitle.innerHTML = `<i data-lucide="book-open-text" class="w-6 h-6 inline-block mr-2 text-indigo-600"></i>10 Weeks of Lab Work (${subjectCode}, ${semesterCode})`;
            lucide.createIcons();

            generateLabWorkLinks(rollNumber, subjectCode, semesterCode);

            showStep3(subjectCode, semesterCode);
        }

        function handleLabLinkClick(labUrl, week) {
            showStatus(`REQUEST INITIATED: Attempting to open Week ${week} link. If the file is missing, the new tab will show an S3 error.`, 'warning');
            window.open(labUrl, '_blank');
        }

        function generateLabWorkLinks(rollNumber, subjectCode, semesterCode) {
            labWorkList.innerHTML = ''; 
            const dynamicSemesterPath = `LAB/${semesterCode}/`; 

            for (let week = 1; week <= 10; week++) {
                const fileName = `${rollNumber}_week${week}.${LAB_WORK_FILE_EXT}`;
                const labUrl = `${S3_BUCKET_BASE}${rollNumber}/${dynamicSemesterPath}${subjectCode}/${fileName}`;

                const fileContainer = document.createElement('div');
                fileContainer.className = 'link-button text-center rounded-xl p-4 flex flex-col items-center justify-center space-y-1 active:scale-98 text-f-light border border-indigo-200'; // Adjusted border
                fileContainer.title = `Full URL: ${labUrl}`;
                fileContainer.setAttribute('onclick', `handleLabLinkClick('${labUrl}', '${week}')`);

                const iconContainer = document.createElement('div');
                iconContainer.className = 'text-3xl text-indigo-600 mb-1'; // Adjusted icon color
                iconContainer.innerHTML = '<i data-lucide="file-text" class="w-7 h-7"></i>';

                const text = document.createElement('span');
                text.className = 'font-semibold text-sm mt-1 break-all';
                text.textContent = `Week ${week}`; 

                fileContainer.appendChild(iconContainer);
                fileContainer.appendChild(text);
                
                labWorkList.appendChild(fileContainer);
            }
            lucide.createIcons();
        }

        // Initialize display on load
        window.onload = function() {
            initThreeJS();
            resetToStep1();
        }
    </script>
</body>
</html>
